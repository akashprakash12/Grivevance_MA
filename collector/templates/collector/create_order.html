{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Collector Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>
<body>
<div class="container mt-4">
    <h2>Create Collector Order</h2>
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="mb-3">
            <label for="id_title" class="form-label">Title</label>
            <input type="text" name="title" id="id_title" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="id_remark" class="form-label">Remark</label>
            <textarea name="remark" id="id_remark" class="form-control" rows="4" required></textarea>
        </div>

        <div class="mb-3">
            <label for="id_due_date" class="form-label">Due Date</label>
            <input type="date" name="due_date" id="id_due_date" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="id_departments" class="form-label">Departments</label>
            <select name="departments[]" id="id_departments" class="form-select" multiple required>
                {% for dept in departments %}
                    <option value="{{ dept.code }}">{{ dept.name }}</option>
                {% endfor %}
            </select>
            <small class="form-text text-muted">Select one or more departments. If no officers are selected, the order will be assigned to the HOD.</small>
        </div>

        <div class="mb-3">
            <label for="id_assigned_officers" class="form-label">Assign Officers (Optional)</label>
            <select name="officers[]" id="id_assigned_officers" class="form-select" multiple>
                <!-- Dynamically populated -->
            </select>
            <small class="form-text text-muted">Leave blank to assign to department HODs.</small>
        </div>

        <div class="mb-3">
            <label for="id_attachment" class="form-label">Attachment (Optional)</label>
            <input type="file" name="attachment" id="id_attachment" class="form-control">
        </div>

        <button type="submit" class="btn btn-primary">Submit</button>
    </form>
</div>

<script>
$(document).ready(function () {
    $('#id_departments').select2({ placeholder: "Select Departments", width: '100%' });
    $('#id_assigned_officers').select2({ placeholder: "Select Officers (Optional)", width: '100%' });

    $('#id_departments').on('change', function () {
        const deptIds = $(this).val();
        $.ajax({
            url: "{% url 'collector:get_officers_by_department' %}",
            data: { 'dept_ids[]': deptIds },
            dataType: 'json',
            success: function (data) {
                const $officerSelect = $('#id_assigned_officers');
                $officerSelect.empty();
                $.each(data.officers, function (i, officer) {
                    $officerSelect.append(new Option(officer.name, officer.id));
                });
                $officerSelect.trigger('change'); // Update Select2
            },
            error: function (xhr, status, error) {
                console.error("AJAX Error:", error);
                console.log("Response:", xhr.responseText);
            }
        });
    });

    // Set min date for due_date
    const today = new Date().toISOString().split('T')[0];
    $('#id_due_date').attr('min', today);
});
</script>
</body>
</html>